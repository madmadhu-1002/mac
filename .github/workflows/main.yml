name: macOS Tailscale SSH + Ollama

on:
  workflow_dispatch:

jobs:
  macos-ssh:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------
      # Install Tailscale
      # ----------------------------
      - name: Install Tailscale
        run: brew install tailscale

      - name: Start Tailscale
        run: |
          sudo tailscaled --state=tailscaled.state &
          sleep 5
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTHKEY }} \
            --hostname=github-macos-runner \
            --ssh

      - name: Show Tailscale IP
        run: tailscale ip -4

      # ----------------------------
      # Enable SSH
      # ----------------------------
      - name: Enable SSH
        run: sudo systemsetup -setremotelogin on

      # ----------------------------
      # Install Ollama (CLI only)
      # ----------------------------
      - name: Install Ollama CLI
        run: |
          brew install ollama
          which ollama
          ollama --version

      # ----------------------------
      # Start Ollama Headless
      # ----------------------------
      - name: Start Ollama Server
        run: |
          nohup ollama serve > ollama.log 2>&1 &
          sleep 10
          curl http://localhost:11434/api/tags || true

      # ----------------------------
      # Pull Smaller Quantized Model (Safer)
      # ----------------------------
      - name: Pull Model
        run: |
          ollama pull qwen2.5-coder:7b

      # ----------------------------
      # Test via API (CI Safe)
      # ----------------------------
      - name: Test Prompt
        run: |
          curl http://localhost:11434/api/generate \
            -d '{
              "model": "qwen2.5-coder:7b",
              "prompt": "hy",
              "stream": false
            }'

      # ----------------------------
      # Keep Runner Alive
      # ----------------------------
      - name: Keep Runner Alive
        run: |
          echo "Runner ready with Ollama + Tailscale"
          sleep 21600
